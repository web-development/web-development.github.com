<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>AJAX - als Präsentation </title>
	<meta name="viewport" content="width=1024, user-scalable=no">
	
	<!-- Replace path with correct path to deck.core.css. -->
	<link rel="stylesheet" href="/assets/css/deck.core.css" type="text/css">
	<link rel="stylesheet" href="/assets/css/style-theme.css" type="text/css">
	<link rel="stylesheet" href="/assets/css/transition-theme.css" type="text/css">
        <link rel="stylesheet" href="/assets/css/deck.goto.css">
        <link rel="stylesheet" href="/assets/css/deck.status.css">
        <link rel="stylesheet" href="/assets/css/deck.hash.css">
        <link rel="stylesheet" href="/assets/css/style.css">
        <style>
          /* google code prettify */
          li.L0, li.L1, li.L2, li.L3, li.L5, li.L6, li.L7, li.L8 {
              list-style-type: inherit !important;
          }
          li.L1, li.L3, li.L5, li.L7, li.L9 {
            background: none repeat scroll 0 0 #EEFEEE;
          }
          ol.linenums {
            margin-left: 80px !important;
          }

          /* deck */
          h4.caption { color: #999999; }
          h4.caption small { color: black; }
          table.table-bordered {
            border-collapse: separate;
          }
          table.table-bordered td,
          table.table-bordered th
          {
            border: 2px white solid;
            padding: 2px;
          }

          .slide img[src$=svg] {
            width: 100%;
          }
        </style>
  
	
	<!-- Any other extension CSS files go here. -->
	
	<!-- Replace path with correct path to Modernizr file. -->
	<script src="/assets/js/modernizr.custom.js"></script>
</head>
<body class="deck-container">

<!-- Create any number of elements with class slide within the container -->
          <div class="slide"><h1>AJAX</h1>
          <p><a href="/applied-javascript/ajax/">zurück zum Buch-Kapitel [esc]</a></p>
          </div>
	  <div class='slide'><p>Wir kennen schon die Funktionsweise von <a href="/http/">HTTP</a>. Bisher
wurde ein HTTP Request durch eine Handlung der UserIn ausgelöst
(URL eintippen, Link anklicken), oder um Ressourcen nachzuladen
die zu einem HTML-Dokument gehören.</p>

<p>Mit AJAX lernen wir nun eine neue Art kennen, wie HTTP-Request
verwendet werden: Asynchrone Requests.</p>

</div>
<div class='slide'>

<h2 id="was-ist-ajax">Was ist AJAX?</h2>

<p>AJAX ist die englische Abkürzung für „Asynchrones Javascript und XML“. In
diesem Kapitel lernen Sie was das genau bedeutet, und dass sich hinter dem X
zum Schluss  auch andere Format verbergen können</p>

<p>Ein Beispiel für die Verwendung von AJAX ist das in Abbildung 50 gezeigte Eingabefeld: 
schon während des Eintippens eines Suchwortes wird eine Anfrage an den Webserver 
geschickt.  Dieser antwortet mit einer Liste von vorgeschlagenen Namen.  Diese Liste 
wird mit Javascript in einer &lt;div&gt; unterhalb des Eingabefelds angezeigt:</p>

<p><img src="/images/image375.png" alt="Abbildung 50: Vorschläge für die Eingabe werden über AJAX geladen" /></p>

<p>Mit AJAX wird hier eine HTTP-Anfrage gesendet. Der Unterschied zu einer 
„normalen“ HTTP-Anfrage:  Bei einer „normalen“ HTTP-Anfrage schaltet der Browser auf 
„Warten“, eine neue vollständige Webseite wird geladen und angezeigt.
Asynchron heisst: der Request wird abgesetzt, das Javascript-Programm läuft sofort 
weiter, die UserIn kann weiterhin mit der Webseite interagieren. Erst wenn die Antwort 
des Servers vorliegt wird die normale Darstellung der Seite kurz unterbrochen und ein 
Javascript-Programm fügt die Daten in die Seite ein. </p>

</div>
<div class='slide'>

<h3 id="im-javascript-programm">Im Javascript Programm</h3>

<p>Auf der Ebene des Javascript Programm-Codes sieht der Unterschied zwischen 
synchron und asynchron so aus:</p>

<div class="example">
<h4 class="caption">Javascript Code <small>synchron</small></h4>
<pre class="lang-javascript prettyprint linenums">
Befehl1();
Befehl2();
Antwort = synchron_laden(url);   // dauert ewig 
Befehl3();                      // viel später
Befehl4();
</pre></div>

<p>Bevor <code>Befehl3</code> ausgeführt werden kann muss erst die Antwort des Servers vorliegen – 
hier kann also eine Wartezeit von mehreren Sekunden entstehen. </p>

<div class="example">
<h4 class="caption">Javascript Code <small>asynchron</small></h4>
<pre class="lang-javascript prettyprint linenums">
function handle_data(Antwort) {  
   ... 
} 
 
Befehl1();
Befehl2();
asynchron_laden(url, handle_data);  // dauert kurz 
Befehl3();                         // kurz darauf
Befehl4();
</pre></div>

<p><code>Befehl3</code> kann sofort ausgeführt werden, egal ob und wie schnell der Server antwortet. 
Wenn die Daten vom Server schließlich einlangen wird die Funktion handle_data 
aufgerufen und die Daten zu verarbeiten. Das kann z.B. gleichzeitig mit <code>Befehl4</code>
erfolgen.</p>

</div>
<div class='slide'>

<h3 id="http">HTTP</h3>

<p>Betrachten wir nun den Ablauf für ein Textfeld mit Autocomplete-Funktion,
wie in der obigen Abbildung gezeigt. Folgende Abbildung ist ein
<a href="http://de.wikipedia.org/wiki/Sequenzdiagramm">Sequenz Diagramm</a>, die Zeit
läuft von oben nach unten.</p>

<p>Zuerst wird die Webseite mit dem Formular geladen: der Browser schickt die
Anfrage an den Server und erhält eine Antwort. Was immer zuvor im Browser
angezeigt wurde wird - nach Ankunft des HTTP Response - gelöscht, die neue
Seite wird im Browser dargestellt.  Diese Verhalten des Browsers ist uns
schon bekannt.</p>

<p>Nun kommt der neue Teil:  das Eintippten des ersten Buchstabens ins
Eingabefeld löst ein Javascript-Programm aus, das einen AJAX-Request absetzt.
Am Netzwerk ist das ein ganz normaler HTTP Request, für den Server gibt
es keinen Unterschied zu jedem anderen Request.  </p>

<p>Was anders ist, ist das Verhalten des Browsers: Wenn die Daten des Response
einlangen wird <strong>nicht</strong> die Seite gelöscht, sondern es wird eine
Javascript-Funktion in der Seite aufgerufen, die die Daten entgegen nimmt.
Für das Autocomple-Verhalten bestehen die Daten aus einer Liste von Vorschlägen,
die Javascript-Funktion zeigt diese Vorschläge unterhalb des Eingabefeldes an.</p>

<p><img src="/images/ajax-sequence-diagram.svg" alt="AJAX Ablauf" /></p>

</div>
<div class='slide'>

<h3 id="datenformate---mehr-als-nur-xml">Datenformate - mehr als nur XML</h3>

<p>Das X am Ende von AJAX steht für XML – das stimmt aber nicht: die Daten vom Server 
können im XML-Format gesendet werden, aber genauso auch als HTML oder reiner 
Text oder JSON. Man könnte das X in AJAX auch als „X-beliebiges Format“ deuten.
Das wichtigste Javascript-Konstrukt für AJAX ist das XMLHTTPRequestObject., das der 
Javascript-Interpreter des Browsers zur Verfügungs stellt. Leider gibt es bei diesem 
Objekt Unterschiede zwischen den Browsern. Um diese Unannehmlichkeiten zu 
vermeiden, sollte man fertige Libraries verwenden, die die Browser-Unterschiede 
verbergen.</p>

</div>
<div class='slide'>

<h2 id="simples-javascript-beispiel">Simples Javascript Beispiel</h2>

<p>Im ersten AJAX Beispiel wird der Output eines PHP-Counters in eine HTML-Seite 
eingebunden. </p>

<div class="example">
<h4 class="caption">Html Code <small>Counter einbinden mit Javascript</small></h4>
<pre class="lang-html prettyprint linenums">
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;AJAX counter&lt;/title&gt;
  &lt;style&gt;
      p#counter_zeile { display: none; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Webseite&lt;/h1&gt;

  &lt;p&gt;mit total viel Inhalt&lt;/p&gt;

  &lt;p id=&quot;counter_zeile&quot;&gt;Counter: &lt;span id=&quot;counter_zahl&quot;&gt;?&lt;/span&gt;&lt;/p&gt;

  &lt;script&gt;
    window.addEventListener('load', loadCounterWithAjax);

    function loadCounterWithAjax() {
      document.getElementById('counter_zeile').style.display = &quot;block&quot;;
      var ajax_request = new XMLHttpRequest();
      ajax_request.addEventListener('load', handleCounterData);
      ajax_request.open(&quot;GET&quot;, &quot;counter_ajax.php&quot;);
      ajax_request.send();
      console.log(&quot;Request wurde gesendet&quot;);
    }

    function handleCounterData() {
      console.log(&quot;Response wurde empfangen&quot;);
      document.getElementById('counter_zahl').innerHTML = 
        this.responseText;
    }
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>

<p>Für den Fall das Javascript nicht funktioniert wird die ganze Counter-Zeile nicht
angezeigt (display:none als style).  Falls Javascript funktioniert wird die
Zeile eingeblendet.</p>

<p>Das <code>XMLHttpRequest</code> Objekt liefert verschiedene Events, hier wird nur für das <code>load</code> Event
eine Funktion als Listener angebracht.  Mit der <code>open</code> methode wird der HTTP-Request
konfiguriert, aber erst mit <code>send</code> wirklich abgeschickt.  Da er Request asynchron erfolgt
geht der Javascript-Interpreter sofort von Zeile 23 in Zeile 24 weiter, und wartet
nicht auf den HTTP-Response.</p>

<p>Erst sehr viel später, wenn der HTTP-Response vorliegt, wird die Funktion
<code>handleCounterData</code> aufgerufen. Die Funktion erhält das <code>XMLHttpRequest</code> Objekt
in der Variable <code>this</code>.</p>

</div>
<div class='slide'>

<h2 id="simples-jquery-beispiel">Simples jQuery Beispiel</h2>

<p>jQuery bietet einige Vereinfachungen gegenüber Javascript:
die Funktion <code>load</code> erledigt nicht nur den AJAX Request, sondern
auch das Einfügen des Rückgabewerts in eine DOM Node:</p>

<div class="example">
<h4 class="caption">Html Code <small>Counter einbinden mit Javascript</small></h4>
<pre class="lang-html prettyprint linenums">
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;AJAX counter&lt;/title&gt;
    &lt;style&gt;
        p#counter_zeile { display: none; }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Webseite&lt;/h1&gt;

    &lt;p&gt;total viel Inhalt&lt;/p&gt;

    &lt;p id=&quot;counter_zeile&quot;&gt;Counter: &lt;span id=&quot;counter_zahl&quot;&gt;?&lt;/span&gt;&lt;/p&gt;

    &lt;script src=&quot;jquery.js&quot;&gt;&lt;/script&gt;
    &lt;script&gt; 
    $(document).ready(function(){ 
        $(&quot;p#counter_zeile&quot;).show();
        $(&quot;#counter_zahl&quot;).load(&quot;counter_ajax.php&quot;);
    });
    &lt;/script&gt;
  &lt;/body&gt;
  &lt;/html&gt;
</pre></div>

<p>Die ganze Arbeit macht hier jQuery in der Zeile</p>

<p><code>$("#counter_zahl").load("counter_ajax.php");</code></p>

<p>Das Element mit der ID counter_zahl wird ausgewählt. Mit dem Load-Befehl wird eine 
AJAX-Anfrage an die angegebene URL abgesetzt. Wenn der HTTP-Response
beim Browser ankommt, werden die gelieferten Daten in das ausgewählte Element eingefügt. 
(Die gelieferten Daten sollten also reiner Text oder ein HTML-Fragment sein.)</p>

</div>
<div class='slide'>

<h2 id="jquery-beispiel-mit-callback-funktion">jQuery Beispiel mit Callback-Funktion</h2>

<p>In diesem Beispiel werden die Daten des Yahoo-Wetterberichts auf mehrere Arten in 
einer Webseite angezeigt. Achtung: Dieses Beispiel benutzt zwar öffentlich zugänglich 
Daten von der Yahoo-Webseite, diese können aber nicht direkt in Javascript geladen 
werden! Wenn man es doch versucht erhält man in Firebug die Fehlermeldung „Access to restricted URI denied“:</p>

<p>Man braucht am eigenen Server ein PHP-Programm das die Daten lädt und wiedergibt:</p>

<div class="example">
<h4 class="caption">Php Code <small>backend um von yahoo den Wetterbericht zu laden</small></h4>
<pre class="lang-php prettyprint linenums">
  &lt;?php 
    // Datei getweather.php
    header (&quot;content-type: text/xml&quot;);
    $url = &quot;http://weather.yahooapis.com/forecastrss?w=2502265&amp;u=c&quot;;
    $xml=file_get_contents( $url );
    if ( $xml == false ) {
        echo &quot;&lt;error&gt;Could not read weather data from yahoo&lt;/error&gt;&quot;;
    } else {
        echo &quot;$xml&quot;;
    }
  ?&gt;
</pre></div>

<p>Der Aufruf der lokalen url <code>getweather.php</code> liefert jetzt die gleichen Daten wie die Yahoo 
Wetterseite. Es handelt sich um Daten im XML-Format, hier ein Auszug:</p>

<div class="example">
<h4 class="caption">Xml Code <small>Yahoo Wetterbericht als XML</small></h4>
<pre class="lang-xml prettyprint linenums">
  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot; ?&gt;
  &lt;rss version=&quot;2.0&quot; xmlns:yweather=&quot;http://xml.weather.yahoo.com/ns/rss/1.0&quot;  
                     xmlns:geo=&quot;http://www.w3.org/2003/01/geo/wgs84_pos#&quot;&gt;
  &lt;channel&gt;
  &lt;description&gt;Yahoo! Weather for San Francisco, CA&lt;/description&gt;
  &lt;geo:lat&gt;37.77&lt;/geo:lat&gt;
  &lt;geo:long&gt;-122.42&lt;/geo:long&gt;
  &lt;pubDate&gt;Mon, 19 Jan 2009 12:56 pm PST&lt;/pubDate&gt;
  &lt;yweather:condition  text=&quot;Fair&quot;  code=&quot;34&quot;  temp=&quot;17&quot;  /&gt;
  &lt;/rss&gt;
&lt;!-- api3.weather.ac4.yahoo.com uncompressed Mon Jan 19 13:23:31 PST 2009 --&gt;
</pre></div>

<p>Im Tag <code>&lt;yweater:condition&gt;</code> ist die Temperatur gespeichert und ein Code der die 
Wetterlage angibt. Unter diesem Code kann man bei Yahoo auch ein Bild zur Wetterlage 
erhalten, z.B: zu den Codes 27, 33, 32 (mostly cloudy at night, fair at night, sunny) die 
URLs</p>

<ul>
  <li><code>http://l.yimg.com/a/i/us/we/52/27.gif</code>  </li>
  <li><code>http://l.yimg.com/a/i/us/we/52/33.gif</code>  </li>
  <li><code>http://l.yimg.com/a/i/us/we/52/34.gif</code></li>
</ul>

<p>und die Bilder</p>

<p>Dies wiederspricht dem 2.REST-Prinzip (siehe nächstes Kapitel): dass nämlich direkt 
URLs angegeben werden sollen, nicht so wie hier ein code, von dem man erst wieder 
wissen muss, wie man ihn interpretiert.</p>

<p>In der Webseite werden die Daten per AJAX geladen, dabei wird eine callback-funktion angegeben:</p>

<div class="example">
<pre class="lang-javascript prettyprint linenums">
$.get(&quot;getweather.php&quot;, handle_the_weather);

function handle_the_weather(data){
   ...
}
</pre></div>

<p>Die Callback-Funktion erhält die geladenen Daten als Argument. Wenn die Daten im 
XML oder HTML-Format sind kann man sie wieder mit jQuery behandeln: den Tag 
<code>&lt;yweather:condition&gt;</code> auswählen und aus dem Tag die Attribute temp und code aus-
lesen:</p>

<div class="example">
<pre class="lang-javascript prettyprint linenums">
  cond =  $(&quot;yweather\\:condition&quot;, data);
  temp = cond.attr(&quot;temp&quot;);
  code = cond.attr(&quot;code&quot;);
</pre></div>

<p>Der Code wird zum Anzeigen des Bildes von Yahoo verwendet:</p>

<div class="example">
<pre class="lang-javascript prettyprint linenums">
  cond =  $(&quot;yweather\\:condition&quot;, data);
  $(&quot;#dasbild&quot;).attr(&quot;src&quot;, &quot;http://l.yimg.com/a/i/us/we/52/&quot; + code + &quot;.gif&quot;);
</pre></div>

<p>Die Temperatur wird doppelt verwendet: einmal wird sie einfach angezeigt:</p>

<div class="example">
<pre class="lang-javascript prettyprint linenums">
  $(&quot;#temp&quot;).text( temp + &quot;°&quot; );
</pre></div>

<p>Und zweitens wird je nach Temperatur die Hintergrundfarbe der Webseite passend ge-
  setzt:</p>

<div class="example">
<pre class="lang-javascript prettyprint linenums">
  if( temp &lt; 0 ) {
      color=&quot;blue&quot;;
  } else if ( temp &lt; 10 ) {
      color=&quot;green&quot;;
  …
  } else {
      color=&quot;red&quot;;
  }
  $(&quot;body&quot;).css(&quot;background-color&quot;,color);
</pre></div>

<p>Hier der vollständige Javascript Code:</p>

<div class="example">
<pre class="lang-javascript prettyprint linenums">
  $.get(&quot;getweather.php&quot;, handle_the_weather);

  function handle_the_weather(data){
      var cond, temp, code, color;
      var cond =  $(&quot;yweather\\:condition&quot;, data);
      temp = cond.attr(&quot;temp&quot;);
      code = cond.attr(&quot;code&quot;);
      $(&quot;#dasbild&quot;).attr(&quot;src&quot;, &quot;http://l.yimg.com/a/i/us/we/52/&quot; + code + 
  &quot;.gif&quot;);
      $(&quot;#temp&quot;).text( temp + &quot;°&quot; );
      if( temp &lt; 0 ) {
          color=&quot;blue&quot;;
      } else if ( temp &lt; 10 ) {
          color=&quot;green&quot;;
      } else if ( temp &lt; 20 ) {
          color=&quot;yellow&quot;;
      } else if ( temp &lt; 30 ) {
          color=&quot;orange&quot;;
      } else {
          color=&quot;red&quot;;
      }
      $(&quot;body&quot;).css(&quot;background-color&quot;,color);
  }
</pre></div>
</div>
          <div class="slide"><h1>Ende</h1>
          <p><a href="/applied-javascript/ajax/">zurück zum Buch-Kapitel [esc]</a></p>
          </div>
	
<!-- Other extension HTML snippets go here, at the bottom of the deck container. -->
<!-- deck.status snippet -->
<p class="deck-status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<!-- Update these paths to point to the correct files. -->
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/deck.core.js"></script>
<script src="/assets/js/deck.hash.js"></script>
<script src="/assets/js/deck.goto.js"></script>
<script src="/assets/js/deck.status.js"></script>

<!-- Add any other extension JS files here -->
<script src="/assets/js/deck.escape.js"></script>

<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
  $(function() {
    $.deck('.slide');
  });
</script>
</body>
</html>
