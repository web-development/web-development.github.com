<!DOCTYPE html> 
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6 web-development"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7 web-development"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8 web-development"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9 web-development"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js web-development"> <!--<![endif]-->
<head> 

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Lehrbuch Web-Development - Fehlerbehandlung</title>
   
  <meta name="author" content="Brigitte Jellinek"> 
  <meta name="description" content="Ein Lehrbuch für das Informatik- oder Medieninformatik-Studium."> 

  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">
  <meta name="generator" content="nanoc 3.1.6">

  <link rel="shortcut icon" href="/assets/img/favicon.ico">

  <link rel="stylesheet" href="/assets/css/bootstrap.css?v=1">
  <link rel="stylesheet" href="/assets/css/prettify.css?v=1">
  <style>
    #booktitle {  border-bottom: 1px solid #EEEEEE; }
    header {  
      position: fixed;
      background-color: white;
      z-index: 1;
    }
    article {  padding-top: 80px; }
    body, p, li, dt, dd {  
      font-size: 15px; 
      line-height: 1.5 ;
    }
  </style>

  <script src="/assets/js/jquery.js?v=1.7.1"></script>
  <script src="/assets/js/bootstrap.js?v=1"></script>
  <script src="/assets/js/prettify.js?v=1"></script>
  <script src="/assets/js/libs/modernizr-1.5.min.js?v=1"></script>

</head>
<body>

<div class="container">

      <a href="http://github.com/bjelline/web-development-textbook/"><img style="position: fixed; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/30f550e0d38ceb6ef5b81500c64d970b7fb0f028/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub"></a>
  <header class="row">
    <div class="jumbotron sub-header span8" id="booktitle">
      <h1><a href="/" title="Web Development">Web Development</a></h1>
      <p class="lead">Ein Lehrbuch für das Informatik oder Medien-Informatik Studium.</p>
    </div>
  </header>
    



	<!-- body -->
	<article id="body" class="row">
		
		<div class="span8">
		
			
                          <div class="page-header">
				<h2 class="title">Fehlerbehandlung</h2>
                                <a href="/php-mysql-2/fehlerbehandlung/slide.html">als Präsentation</a>
                          </div>
			
			
			<div class='slide'><p>Wir haben bisher keinerlei Rücksicht darauf genommen, dass ein Fehler auftreten
könnte.  Zum Beispiel könnte beim Einfügen in die Datenbank ein Constraint verletzt werden
und das Einfügen fehlschlagen. Wie behandelt man diesen Fall in PHP?</p>

</div>
<div class='slide'>

<h2 id="exceptions-in-php">Exceptions in PHP</h2>

<p>Folgende Beschreibung ist aus dem <a href="http://www.php.net/manual/de/language.exceptions.php">PHP Handbuch</a> übernommen:</p>

<p>PHP 5 hat ein Exceptionmodell ähnlich dem anderer Programmiersprachen. Eine Exception kann in PHP 
geworfen (<code>throw</code>) und abgefangen (<code>catch</code>) werden. Um das Fangen potentieller Exceptions zu 
ermöglichen, wird der jeweilige Code mit einem <code>try</code>-Block umschlossen. </p>

<p>Jeder <code>try</code>-Block muss mindestens einen zugehörigen <code>catch</code> Block besitzen. 
Mehrere <code>catch</code>-Blöcke können verwendet werden, um verschiedene Klassen von Exceptions abzufangen. 
Die normale Programmausführung (wenn keine Exception innerhalb des <code>try</code>-Blockes geworfen wird 
oder keine zur Klasse der geworfenen Exception passendes <code>catch</code> vorhanden ist) 
wird nach dem letzten <code>catch</code>-Block fortgesetzt. 
Exceptions können innerhalb eines <code>catch</code>-Blockes geworfen (oder weitergeworfen) werden.</p>

<p>Wenn eine Exception geworfen wird, wird der Programmcode der auslösenden Anweisung nicht ausgeführt, 
und PHP versucht, den ersten passenden <code>catch</code>-Block zu finden. Falls eine Exception gar
nicht abgefangen wird, wird ein fataler Fehler mit einer “Uncaught Exception …“-Nachricht ausgegeben</p>

<div class="example">
<h4 class="caption">Php Code <small>Beispiel für Exception-Handling in PHP: Division durch Null</small></h4>
<pre class="lang-php prettyprint linenums">
  &lt;?php
  function inverse($x) {
      if ($x == 0) {
         throw new Exception('Division durch Null.');
      }
      return 1 / $x;
  }

  try {
      echo inverse(5) . &quot;\n&quot;;
      echo inverse(0) . &quot;\n&quot;;
  } catch (Exception $e) {
      echo 'Exception abgefangen: ',  $e-&gt;getMessage(), &quot;\n&quot;;
  }

  // output:
  // 0.2
  // Exception abgefangen: Division durch Null
  ?&gt;
</pre></div>

</div>
<div class='slide'>

<h2 id="verwendung-von-exceptions-fr-die-datenbank">Verwendung von Exceptions für die Datenbank</h2>

<p>In folgendem Beispiel soll ein Datensatz (plus abhängige Daten) dargestellt werden.
Dabei könnte schon beim Verbindungsaufbau mit der Datenbank ein Fehler auftreten,
oder bei einzelnen Abfragen.</p>

<div class="example">
<h4 class="caption">Php Code <small>Datenbank-Abfrage mit Exception Handling als Fehlerbehandlung</small></h4>
<pre class="lang-php prettyprint linenums">
   $get_pid   = $_GET['pid'];
   try{
      include &quot;config.php&quot;;

      if( ! $DB_NAME ) throw (new Exception( &quot;Datenbank-Verbindung ist nicht konfiguriert. Bitte die Datei config.php anlegen!&quot; ));

      $dbh = new PDO(&quot;mysql:dbname=$DB_NAME&quot;, $DB_USER, $DB_PASS);
      $dbh-&gt;exec('SET CHARACTER SET utf8') ;

      $sth  = $dbh-&gt;prepare( &quot;SELECT * FROM `users` WHERE id=?&quot; );
      $sth-&gt;setFetchMode(PDO::FETCH_OBJ);
      $sth-&gt;execute(array($get_pid));
      $p = $sth-&gt;fetch();

      // wirklich nicht in der Datenbank
      if( $p === false )          throw (new Exception( &quot;Konnte Person Nr. $get_pid in der Datenbank nicht finden.&quot; ));

      // Profil verborgen
      if( !$p-&gt;profile_visible  ) throw (new Exception( &quot;Konnte Person Nr. $get_pid in der Datenbank nicht finden.&quot; ));

      $sth  = $dbh-&gt;prepare( &quot; .... &quot; );
      $sth-&gt;execute(array($get_pid));
      $projects = $sth-&gt;fetchAll(PDO::FETCH_OBJ);

    } catch( Exception $e ) {
      include &quot;header.php&quot;;
      echo &quot;&lt;h1&gt;Error&lt;/h1&gt;&quot; ;
      echo &quot;&lt;p&gt;&quot; . $e-&gt;getMessage() . &quot;&lt;/p&gt;&quot;;
      include &quot;footer.php&quot;;
      exit;
    }

/* hier folgt die normale Ausgabe der Seite */
</pre></div>

<p>In diesem Beispiel erfolgt die ganze Arbeit mit der Datenbank
bevor die Ausgabe beginnt.  Im <code>catch</code>-Block wird eine Webseite
erzeugt, die gar nichts mit der “normalen” Ausgabe der Seite zu
tun hat.</p>

</div>
<div class='slide'>

<h2 id="transaktionen-und-rollback">Transaktionen und Rollback</h2>

<p>Sie kennen Transaktionen auf Ebene von SQL, hier am Beispiel von MySQL gezeigt.
(siehe das <a href="http://dev.mysql.com/doc/refman/5.1/de/commit.html">MySQL Referenz Handbuch</a>)</p>

<div class="example">
<h4 class="caption">Sql Code <small>Beispiel für eine Transaktion in MySQL, die zwei Einfüge-Operationen zusammenfasst</small></h4>
<pre class="lang-sql prettyprint linenums">
START TRANSACTION;
INSERT INTO staff (id, first, last) VALUES (42, 'Alyssa', 'Hacker');
INSERT INTO salarychange (id, amount, changedate) VALUES (42, 50000, NOW());
COMMIT;
</pre></div>

<div class="example">
<h4 class="caption">Sql Code <small>Beispiel für eine Transaktion in MySQL und zurück-gerollt wird</small></h4>
<pre class="lang-sql prettyprint linenums">
START TRANSACTION;
INSERT INTO staff (id, first, last) VALUES (42, 'Alyssa', 'Hacker');
INSERT INTO salarychange (id, amount, changedate) VALUES (42, 50000, NOW());
ROLLBACK;
-- nichts ist passiert!
</pre></div>

<p>Die Datenbankschnittstelle <code>PDO</code> bietet für den Umgang mit Transaktionen die 
Methoden <code>beginTransaction</code>, <code>commit</code> und <code>rollback</code> an.</p>

<p>Und einen besonderen Service: Wenn die Datenbank-Verbindung
geschlossen wird obwohl noch eine Transaktion offen ist, dann löst PDO selbst
das Rollback aus.</p>

<div class="example">
<h4 class="caption">Php Code <small>Beispiel für Transaktion mit Fehlerbehandlung</small></h4>
<pre class="lang-php prettyprint linenums">
try {
  $dbh-&gt;beginTransaction();
  $dbh-&gt;exec(&quot;INSERT INTO staff (id, first, last) VALUES (42, 'Alyssa', 'Hacker')&quot;);
  $dbh-&gt;exec(&quot;INSERT INTO salarychange (id, amount, changedate) VALUES (42, 50000, NOW())&quot;);
  $dbh-&gt;commit();
  
} catch (Exception $e) {
  $dbh-&gt;rollBack();
  echo &quot;Error: &quot; . $e-&gt;getMessage();
}
</pre></div>

<p>Bei einem realen Beispiel würde man nicht die <code>exec</code> Methode verwenden,
sondern wahrscheinlich prepared Statements. Aber die generelle Vorgehensweise
bleibt gleich.</p>

</div>
<div class='slide'>

<h2 id="exceptions-in-javascript">Exceptions in Javascript</h2>

<p>Die Verwendung und Schreibweise ist in Javascript so ähnelich, dass es sich
gar nicht lohnt näher darauf einzugehen. Siehe <a href="http://www.magjs.de/2012-01/rauschmayer/rauschmayer.html">Rauschmayer(2012): Ausnahmebehandlung in JavaScript in mag.js Nr.1</a></p>
</div>
		
			<div class="pagination">
  <ul>
    
      <li><a href="/php-mysql-2/daten-editieren/">← <span class="article">Daten Bearbeiten</a></li>
    
    
      <li><a href="/security/">Web Security →</a></li>
    
  </ul>
</div>

		</div>
		
		<!-- sidebar -->
<div id="sidebar" class="span3 offset1">
        <div class="page-header"> 
        <h2>Kapitel</h2>
        </div>

        
        <ul class="nav nav-list">
        
          
            <li ><a href="/das-web-und-html/">DAS WEB UND HTML</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/das-web-und-html/geschichte/">Eine Kurze Geschichte des World Wide Web</a></li>
                      
                    
                      
                      <li ><a href="/das-web-und-html/standards/">Drei Standards definieren das Web</a></li>
                      
                    
                      
                      <li ><a href="/das-web-und-html/html-grundkurs/">HTML Grundkurs</a></li>
                      
                    
                      
                      <li ><a href="/das-web-und-html/upload/">Upload und Tools</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/css/">CSS</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/css/css-kurz/">Kurzvorstellung von Stylesheets</a></li>
                      
                    
                      
                      <li ><a href="/css/geschichte/">Geschichte von CSS</a></li>
                      
                    
                      
                      <li ><a href="/css/css/">Syntax von CSS</a></li>
                      
                    
                      
                      <li ><a href="/css/graceful/">Graceful Degradation</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/css-layout/">CSS LAYOUT</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/css-layout/rahmenbedingungen/">Rahmenbedingungen für Layout</a></li>
                      
                    
                      
                      <li ><a href="/css-layout/layout/">CSS für Layout</a></li>
                      
                    
                      
                      <li ><a href="/css-layout/navigation/">Navigationsmenü</a></li>
                      
                    
                      
                      <li ><a href="/css-layout/interaktion/">CSS für Interaktion</a></li>
                      
                    
                      
                      <li ><a href="/css-layout/selektoren/">CSS Selektoren im Detail</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/urls/">URLS</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/urls/absolut-relativ/">Absolute und relative URLs</a></li>
                      
                    
                      
                      <li ><a href="/urls/konfiguration/">Konfiguration</a></li>
                      
                    
                      
                      <li ><a href="/urls/tipps/">Pragmatische Tipps</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/formulare/">FORMULARE</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/formulare/form/">Formulare</a></li>
                      
                    
                      
                      <li ><a href="/formulare/interaktion/">Formular als Interaktion</a></li>
                      
                    
                      
                      <li ><a href="/formulare/action/">Daten absenden</a></li>
                      
                    
                      
                      <li ><a href="/formulare/php/">Formular und PHP</a></li>
                      
                    
                      
                      <li ><a href="/formulare/javascript/">Formular und Javascript</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/javascript-dom/">JAVASCRIPT DOM</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/javascript-dom/hintergrund/">Hintergründe</a></li>
                      
                    
                      
                      <li ><a href="/javascript-dom/basic-javascript/">Basic Javascript</a></li>
                      
                    
                      
                      <li ><a href="/javascript-dom/dom/">DOM</a></li>
                      
                    
                      
                      <li ><a href="/javascript-dom/canvas/">2D Canvas</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/jquery/">JQUERY</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/jquery/unobstrusive/">Unobstrusive Javascript</a></li>
                      
                    
                      
                      <li ><a href="/jquery/schreibweise/">Besondere Javascript-Schreibwesen in jQuery</a></li>
                      
                    
                      
                      <li ><a href="/jquery/selektieren-manipulieren/">Selektieren und Manipulieren mit jQuery</a></li>
                      
                    
                      
                      <li ><a href="/jquery/interaktion/">Interaktion mit jQuery</a></li>
                      
                    
                      
                      <li ><a href="/jquery/formularpruerung/">Formulardaten Prüfen mit jQuery</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/php-vorbereitung/">PHP VORBEREITUNG</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/php-vorbereitung/was-ist-php/">Was ist PHP? Was passiert am Webserver?</a></li>
                      
                    
                      
                      <li ><a href="/php-vorbereitung/apache/">Apache</a></li>
                      
                    
                      
                      <li ><a href="/php-vorbereitung/erstes-php-programm/">Das erste PHP-Programm</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/http/">HTTP</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/http/tcpip-und-dns/">TCP/IP und DNS</a></li>
                      
                    
                      
                      <li ><a href="/http/http/">HTTP</a></li>
                      
                    
                      
                      <li ><a href="/http/php-erzeugt/">PHP erzeugt nicht nur HTML</a></li>
                      
                    
                      
                      <li ><a href="/http/php-und-parameter/">In PHP Daten aus Web-Formularen verarbeiten</a></li>
                      
                    
                      
                      <li ><a href="/http/datei-upload/">Datei Upload</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/git/">GIT</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/git/versionskontrolle/">Versionskontrolle</a></li>
                      
                    
                      
                      <li ><a href="/git/basic-git/">Einfacher Arbeitsablauf in Git</a></li>
                      
                    
                      
                      <li ><a href="/git/git-status/">Status von Git abfragen</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/wordpress/">WORDPRESS</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/wordpress/was-ist-wordpress/">Was ist Wordpress</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/installation/">Kurz-Installation von Wordpress</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/security/">Security</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/backend/">Überblick Backend</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/seiten/">Artikel und Seiten</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/multimedia/">Multimedia-Dateien</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/themes-sidesbars-widgets/">Themes, Sidebars und Widgets verwenden</a></li>
                      
                    
                      
                      <li ><a href="/wordpress/plugins/">Plugins verwenden</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/php/">PHP</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/php/warnhinweis/">Warnhinweis</a></li>
                      
                    
                      
                      <li ><a href="/php/syntax/">Syntax von PHP</a></li>
                      
                    
                      
                      <li ><a href="/php/dateien/">Dateien und Ordnern in PHP</a></li>
                      
                    
                      
                      <li ><a href="/php/mail/">PHP und E-Mail</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/php-mysql/">PHP MYSQL</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/php-mysql/start/">Start mit PHP und MySQL</a></li>
                      
                    
                      
                      <li ><a href="/php-mysql/datenbank-lesen/">Eine lesende Web-Applikation</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/session/">SESSION</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/session/session-und-login/">Session und Login</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li class="active"><a href="/php-mysql-2/">PHP MYSQL 2</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/php-mysql-2/datenbank-schreiben/">Web-Applikation mit Schreibrecht</a></li>
                      
                    
                      
                      <li ><a href="/php-mysql-2/daten-loeschen/">Löschen</a></li>
                      
                    
                      
                      <li ><a href="/php-mysql-2/daten-einfuegen/">Einfügen</a></li>
                      
                    
                      
                      <li ><a href="/php-mysql-2/daten-editieren/">Daten Bearbeiten</a></li>
                      
                    
                      
                      <li class="active"><a href="/php-mysql-2/fehlerbehandlung/">Fehlerbehandlung</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/security/">SECURITY</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/security/a1-injection/">Injection</a></li>
                      
                    
                      
                      <li ><a href="/security/a2-xss/">Cross Site Scripting (XSS)</a></li>
                      
                    
                      
                      <li ><a href="/security/a3-auth/">Authentifizierung und Session-Management</a></li>
                      
                    
                      
                      <li ><a href="/security/a4-referenz/">Unsichere direkte Objektreferenzen</a></li>
                      
                    
                      
                      <li ><a href="/security/a5-csrf/">Cross-Site Request Forgery (CSRF)</a></li>
                      
                    
                      
                      <li ><a href="/security/a6-konfiguration/">Sicherheitsrelevante Fehlkonfiguration</a></li>
                      
                    
                      
                      <li ><a href="/security/a7-krypto/">Kryptografisch unsichere Speicherung</a></li>
                      
                    
                      
                      <li ><a href="/security/a8-url/">Mangelhafter URL-Zugriffsschutz</a></li>
                      
                    
                      
                      <li ><a href="/security/a9-transport/">Unzureichende Absicherung der Transportschicht</a></li>
                      
                    
                      
                      <li ><a href="/security/a10-redirect/">Ungeprüfte Um- und Weiterleitungen</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/svg/">SVG</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/svg/was-ist-svg/">Was ist SVG</a></li>
                      
                    
                      
                      <li ><a href="/svg/formen/">Grundformen in SVG</a></li>
                      
                    
                      
                      <li ><a href="/svg/koordinaten/">Koordinaten und Transformationen</a></li>
                      
                    
                      
                      <li ><a href="/svg/js-svg/">Javascript und SVG</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
            <li ><a href="/javascript/">JAVASCRIPT</a>
              <ul class="sub">
                
                  
                    
                      
                    
                      
                      <li ><a href="/javascript/funktionen/">Funktionen und this</a></li>
                      
                    
                      
                      <li ><a href="/javascript/closures/">Funktionen und Closures</a></li>
                      
                    
                      
                      <li ><a href="/javascript/objekte/">Objekte + Prototypen</a></li>
                      
                    
                      
                      <li ><a href="/javascript/event-und-closure/">Events und Closures</a></li>
                      
                    
                      
                      <li ><a href="/javascript/style/">Stil + Tipps</a></li>
                      
                    
                  
                
              </ul>
            </li>
          
        
        </ul>

</div>
<!-- sidebar -->

		
	</article>
	<!-- /body -->


  <div class="row">
    <div class="span12" id="legal">
        <p class="copyright">veröffentlicht unter <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/at/deed.de">creative commons by-nc-sa</a> im Jahr 2012 von <a href="#">Brigitte Jellinek</a>.
        <p>Zum Weiterentwickeln dieser Seite: <a href="https://github.com/bjelline/web-development-textbook/fork_select">Projekt forken</a> oder <a href="https://github.com/bjelline/web-development-textbook/blob/master/content/php-mysql-2/fehlerbehandlung.md">kommentar zu dieser seite</a></p>

</p>
    </div>
  </div>

</div> <!-- class="container" -->

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script>!window.jQuery && document.write(unescape('%3Cscript src="/assets/js/libs/jquery-1.6.4.min.js"%3E%3C/script%3E'))</script>
<script>
  $(document).ready(function(){
    function save_state(){
      var stored = "";
      $('ul.nav > li').each(function(i,e){
        if( $(e).find("i").attr('class') == 'icon-plus' ) {
          stored += "-";
        }  else {
          stored += "+";
        }
      });
      localStorage.setItem('nav-state', stored);
    }
    $('ul.nav > li > a').prepend("<i class='icon-plus'></i>");

    // init state
    var stored = localStorage.getItem('nav-state');
    if ( stored ) {
      var data = stored.split("");
      $('ul.nav > li').each(function(i,e){
        if( data[i] == "+" ) {
          $(e).find(">ul").show();
          $(e).find("i").removeClass('icon-plus').addClass('icon-minus');
        } else {
          $(e).find(">ul").hide();
        }
      });
    } else {
      $('ul.nav ul.sub').hide();
    }
    $('ul.nav li.active ul.sub').show();
    $('ul.nav li.active i').removeClass('icon-plus').addClass('icon-minus');

    $('ul.nav i').click(function(){
      $this = $(this); 
      $this.toggleClass('icon-plus').toggleClass('icon-minus');
      $this.parent().next('ul').toggle();
      save_state();
      return false;
    });
  });
</script>
</body> 
</html>

