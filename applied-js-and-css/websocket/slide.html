<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>Chat Websockets - als Präsentation</title>
    <meta name="viewport" content="width=1024, user-scalable=no" />

    <!-- Replace path with correct path to deck.core.css. -->
    <link rel="stylesheet" href="/assets/css/deck.core.css" type="text/css" />
    <link rel="stylesheet" href="/assets/css/style-theme.css" type="text/css" />
    <link
      rel="stylesheet"
      href="/assets/css/transition-theme.css"
      type="text/css"
    />
    <link rel="stylesheet" href="/assets/css/deck.goto.css" />
    <link rel="stylesheet" href="/assets/css/deck.status.css" />
    <link rel="stylesheet" href="/assets/css/deck.hash.css" />
    <link rel="stylesheet" href="/assets/css/style.css" />

    <style>
      /* google code prettify */
      li.L0,
      li.L1,
      li.L2,
      li.L3,
      li.L5,
      li.L6,
      li.L7,
      li.L8 {
        list-style-type: inherit !important;
      }
      li.L1,
      li.L3,
      li.L5,
      li.L7,
      li.L9 {
        background: none repeat scroll 0 0 #eefeee;
      }
      ol.linenums {
        margin-left: 80px !important;
      }

      /* deck */
      h4.caption {
        color: #999999;
      }
      h4.caption small {
        color: black;
      }
      table.table-bordered {
        border-collapse: separate;
      }
      table.table-bordered td,
      table.table-bordered th {
        border: 2px white solid;
        padding: 2px;
      }

      .slide img[src$="svg"] {
        width: 100%;
      }
    </style>

    <!-- Any other extension CSS files go here. -->

    <!-- Replace path with correct path to Modernizr file. -->
    <script src="/assets/js/modernizr.custom.js"></script>
  </head>
  <body class="deck-container">
    <!-- Create any number of elements with class slide within the container -->
    <div class="slide">
      <h1>Chat Websockets</h1>
      <p>
          vorige Präsentation:
        <a href="/applied-js-and-css/cors//slide.html">CORS</a> | 
        <a href="/applied-js-and-css/websocket/"
          >zurück zum Buch-Kapitel [esc]</a
        >
         
        | Nächste Präsentation
        <a href="/json//slide.html">JSON</a>
        
      </p>
    </div>
    <div class="slide">
<p>HTTP fängt immer mit dem Request des Browsers and, und endet mit dem Response des Servers.
Dieses Protokoll ist nicht geeignet für Chat, für Spiele, …. wo die Kommunikation
auch vom Server ausgehen muss.</p>

<p>Das Websocket Protokoll ermöglicht die Kommunikation in beide Richtungen auf
einer dauerhaften Verbindung zwischen Client und Server.</p>

</div>
<div class="slide">

<h2 id="das-websocket-protokoll">Das Websocket Protokoll</h2>

<p>Das Websockets Protokol baut auf HTTP and HTTPS auf:</p>

<ul>
  <li>es verwendet die ports 80 bzw. 443</li>
  <li>es startet immer mit einem normalen HTTP Request</li>
  <li>es verwende Cookies</li>
</ul>

<p>Aber nach dem ersten Request wird die TCP Verbindung auf Dauer aufrechterhalten,
und Client und Server wechseln in das eigentlih Websocket Protokoll:</p>

<p>```
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Origin: http://example.com
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13</p>

<p>HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: chat 
```</p>

<p>Nach diesem ersten Austausch müssen sowohl Server als auch Client
jederzeit mit eingehenden Nachrichten umgehen.</p>

</div>
<div class="slide">

<h2 id="developer-tools">Developer Tools</h2>

<p>Beim Programmieren und Debuggen von Websockets braucht man die
Developer Tools: In der “Netzwerkanalyse” sieht man den ersten
Request, noch mit HTTP, der dann mit “101 Switching Protocol” in eine Websocket 
umgewandelt wird:</p>

<p><img src="/images/websockets/dev-tools-network.png" srcset="/images/websockets/dev-tools-network-1.png 1x, /images/websockets/dev-tools-network-2@2x.png 2x, /images/websockets/dev-tools-network@2x.png 2x, /images/websockets/dev-tools-network-2.png 1x, /images/websockets/dev-tools-network-1@2x.png 2x, /images/websockets/dev-tools-network.png 1x"  alt="" >
<img src="/images/websockets/dev-tools-network-1.png" srcset="/images/websockets/dev-tools-network-1.png 1x, /images/websockets/dev-tools-network-1@2x.png 2x"  alt="" ></p>

<p>Im Tab “Nachrichten” sieht man die Nachrichten die hin oder her geschickt werden:</p>

<p><img src="/images/websockets/dev-tools-network-2.png" srcset="/images/websockets/dev-tools-network-2@2x.png 2x, /images/websockets/dev-tools-network-2.png 1x"  alt="" ></p>

<p>Hier sieht man auch dass Client und Server sich gegenseitig
“Ping”-Pakete senden wenn sonst nichts zu senden ist.</p>

</div>
<div class="slide">

<h2 id="nodejs">node.js</h2>

<p>Für die Programmierung am Server kann man PHP, Ruby,…. alle typischen
Backend-Programmiersprachen verwenden.  Wir nutzen die Gelegenheit
um <code>node.js</code> kennen zu lernen. Damit kann man das Backend in JavaScript programmieren.</p>

<p>Node.js kann man <a href="https://nodejs.org/en/download/">am eigenen Rechner installieren</a>, das
ist aber für diese Beispiel nicht nötig. Wir verwenden <a href="https://glitch.com/">https://glitch.com/</a>:</p>

<p><img src="/images/websockets/glitch.png" srcset="/images/websockets/glitch.png 1x, /images/websockets/glitch@2x.png 2x"  alt="" ></p>

<p>Damit enfällt das nochladen des Codes auf einen Server.</p>

</div>
<div class="slide">

<h2 id="socketio">Socket.io</h2>

<p>socket.io
Library for both server and client side JS code
Needs express as a basis</p>

<p>WARNING: 
socket.io will automatically host some files needed on the client side under the URL /socket.io/  Do not attempt to change this!</p>

<p>Load in client:</p>

<p><code>
&lt;script src="socket.io/socket.io.js"&gt;&lt;/script&gt;
</code></p>

</div>
<div class="slide">

<h2 id="overview">Overview</h2>

<p>```
const app = require(‘express’)();
const http = require(‘http’).Server(app);
const io = require(‘socket.io’)(http);
const port = process.env.PORT || 5000;</p>

<p>app.use(express.static(‘public’));</p>

<p>http.listen(port, function(){
  console.log(“webserver started”);
});</p>

<p>io.on(…)</p>

<p>// export app so we can test it
exports = module.exports = app;</p>

<p>```</p>

</div>
<div class="slide">

<h2 id="client">Client</h2>

<p>```</p>
<ul id="messages"></ul>
<form action="">
  <input id="m" autocomplete="off" /><button>Send</button>
</form>
<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

<script src="socket.io/socket.io.js"></script>

<p>```</p>

<p>Sending messages to the server:</p>

<p><code>
&lt;script&gt;
  var socket = io();
  $('form').submit(function(){
    socket.emit('chat message', $('#m').val());
    $('#m').val('');
    return false;
  });
&lt;/script&gt;
</code></p>

<p>Recieving messages from the server:</p>

<p><code>
  socket.on('chat message', function(msg){
    $('#messages').append($('&lt;li&gt;').text(msg));
  });
</code></p>

</div>
<div class="slide">

<h2 id="server">Server</h2>

<p>```
io.on(‘connection’, function(socket){
  console.log(‘a user connected’);</p>

<p>socket.on(‘chat message’, function(msg){
    console.log(<code>got message '${msg}', broadcasting to all</code>);
    io.emit(‘chat message’, msg);
  });</p>

<p>socket.on(‘disconnect’, function(){
    console.log(‘user disconnected’);
  });
});
```</p>

</div>
<div class="slide">

<h2 id="testing-the-server">Testing the Server</h2>

<p>```
describe(“Auction Server”,function(){
  it(‘Should echo chat massages back to user’, function(done){
    var client1 = io.connect(socketURL, options);</p>

<pre><code>client1.on('connect', function(data){
  client1.emit('chat message', 'hello world');
  client1.on('chat message', function(data){
    console.log('got back ' + data);
    data.should.equal('hello world');
    client1.disconnect();
    done();
  });
});   }); });
</code></pre>

<p>```</p>

</div>
<div class="slide">

<h2 id="see-also">See Also</h2>

<ul>
  <li><a href="https://tools.ietf.org/html/rfc6455">RFC 6455</a></li>
</ul>
</div>
    <div class="slide">
      <h1>Chat Websockets</h1>
      <p>
          vorige Präsentation:
        <a href="/applied-js-and-css/cors//slide.html">CORS</a> | 
        <a href="/applied-js-and-css/websocket/"
          >zurück zum Buch-Kapitel [esc]</a
        >
         
        | Nächste Präsentation
        <a href="/json//slide.html">JSON</a>
        
      </p>
    </div>

    <!-- Other extension HTML snippets go here, at the bottom of the deck container. -->
    <!-- deck.status snippet -->
    <p class="deck-status">
      <span class="deck-status-current"></span>
      /
      <span class="deck-status-total"></span>
    </p>

    <!-- deck.hash snippet -->
    <a href="." title="Permalink to this slide" class="deck-permalink">#</a>

    <!-- Update these paths to point to the correct files. -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/deck.core.js"></script>
    <script src="/assets/js/deck.hash.js"></script>
    <script src="/assets/js/deck.goto.js"></script>
    <script src="/assets/js/deck.status.js"></script>

    <!-- Add any other extension JS files here -->
    <script src="/assets/js/deck.escape.js"></script>

    <!-- Initialize the deck. You can put this in an external file if desired. -->
    <script>
      $(function() {
        $.deck(".slide");
      });
    </script>
  </body>
</html>
